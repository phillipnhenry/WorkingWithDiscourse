Make these your own
  IAM user: your-iam-user
  Policy: s3-discourse-policy-your-iam-user
  Uploads bucket: your-bucket-name-uploads
  Backups bucket: your-bucket-name-backups
  Distribution CDNs: discourse-cdn.yourdomain.tld and s3-cdn.yourdomain.tld

AWS S3 Configuration
  Discourse instance domain: subdomain.yourdomain.tld (subdomain.yourdomain.tld including www.yourdomain.tld)
  IAM user: yourdomain-subdomain (yourdomain-discourse, yourdomain-forum or Discourse in apex/root: yourdomain-tld-www )
  Policy for IAM user: s3-discourse-policy-yourdomain-subdomain
  Uploads bucket: yourdomain-subdomain-uploads Note: Don't forget to set "Everyone (public access)" to "Read" in Bucket>Permissions: Access control list-(ACL) Access control list (ACL)-Grantee.
  Backups bucket: yourdomain-subdomain-backups
  Distribution CDNs: discourse-cdn.yourdomain.tld and s3-cdn.yourdomain.tld

IAM User
S3 Policy
S3 Buckets

Distribution #1
  DISCOURSE_CDN_URL
    Distribution name: cdn-yourdomain-subdomain
    Origin: subdomain.yourdomain.tld
    Distribution domain name (Cloudfront URL): AWS-assigned.cloudfront.net
    Alternate domain names: discourse-cdn.yourdomain.tld

Distribution #2
  DISCOURSE_S3_CDN_URL
    Distribution name: s3-yourdomain-subdomain-uploads
    Origin: yourdomain-subdomain-uploads
    Distribution domain name (Cloudfront URL: AWS-assigned.cloudfront.net
    Alternate domain names: s3-cdn.yourdomain.tld

Discourse Configuration

Visit your admin UI(https://discourseinstance.yourdomain.tld/admin/site_settings/category/all_results?filter=S3) then enable "S3 use CDN URL for all uploads" by selecting “Use CDN URL for all the files uploaded to s3 instead of only for images.” (Discourse ships deselected)

Edit your app.yml making the changes below for branded URLs or unbranded Cloudfront URLs.

Use this for unbranded Cloudfront distributions. Your DISCOURSE_S3_REGION might be different.
DISCOURSE_CDN_URL: https://AWS-assigned.cloudfront.net

S3 storage config (unbranded)
  ## S3 storage config
  DISCOURSE_USE_S3: true
  DISCOURSE_S3_REGION:  us-east-1
  DISCOURSE_S3_ACCESS_KEY_ID: Access key
  DISCOURSE_S3_SECRET_ACCESS_KEY: Secret access key
  DISCOURSE_S3_CDN_URL: https://AWS-assigned.cloudfront.net
  DISCOURSE_S3_BUCKET: your-bucket-name-uploads
  DISCOURSE_S3_BACKUP_BUCKET: your-bucket-name-backups
  DISCOURSE_BACKUP_LOCATION: s3

DNS Configuration
If you prefer to use yourdomain.com based URLs for the CDNs you need to make some DNS changes and adjust your CDN URLs.
Note: Don't forget to add discourse-cdn.yourdomain.com and s3-cdn.yourdomain.com as a domain name in "Alternate domain names" for their respective Cloudfront distributions.

DNS config if you want to use domain branded Cloudfront distributions.
DISCOURSE_CDN_URL
  Existing record:	A   discourseinstance.yourdomain.tld   instance ip  Note: This is the existing Discourse install ip.
  New record:		A   discourse-cdn-cloudfront.yourdomain.tld   instance ip
  New record: 		CNAME discourse-cdn.yourdomain.tld   -->   AWS-assigned.cloudfront.net

DISCOURSE_S3_CDN_URL
  New record:		CNAME s3-cdn-cloudfront.yourdomain.tld   -->   AWS-assigned.cloudfront.net
  New record: 		CNAME  s3-cdn.yourdomain.tld   -->   s3-cdn-cloudfront.yourdomain.tld

Once the DNS changes are complete you can edit your app.yml making the changes below.

Change DISCOURSE_CDN_URL and/or DISCOURSE_S3_CDN_URL if you are using domain CNAMES for the Cloudfront distribution (AWS-assigned.cloudfront.net).

DISCOURSE_CDN_URL: https://discourse-cdn.yourdomain.tld

S3 storage config (branded)
## S3 storage config
  DISCOURSE_USE_S3: true
  DISCOURSE_S3_REGION:  us-east-1
  DISCOURSE_S3_ACCESS_KEY_ID: Access key
  DISCOURSE_S3_SECRET_ACCESS_KEY: Secret access key
  DISCOURSE_S3_CDN_URL: https://s3-cdn.yourdomain.tld
  DISCOURSE_S3_BUCKET: your-bucket-name-uploads
  DISCOURSE_S3_BACKUP_BUCKET: your-bucket-name-backups
  DISCOURSE_BACKUP_LOCATION: s3

Additional app.yml edits
Regardless of which approach you use, branded or Cloudfront URLs, you will need the after_assets_precompile section below to ensure things stay updated during subsequent rebuilds.
  hooks:
    after_code:
      - exec:
          cd: $home/plugins
          cmd:
            - git clone https://github.com/discourse/docker_manager.git
            -you may have more plugins
    after_assets_precompile:
      - exec:
          cd: $home
          cmd:
            - sudo -E -u discourse bundle exec rake s3:upload_assets
            - sudo -E -u discourse bundle exec rake s3:expire_missing_assets

Rebuild your instance with  ./launcher rebuild app

After ./launcher rebuild app completes successfully do these rakes.

./launcher enter app

rake posts:rebake
rake uploads:migrate_to_s3
rake posts:rebake_uncooked_posts

rake s3:upload_assets
rake s3:expire_missing_assets

If the rakes complete without errors then you are good to go. Move onto configuring Lifecycle rules for your-bucket-name-backups.

On some sites the initial rebuild will fail with an error relating to s3:upload_assets. If this happens comment out or remove

after_assets_precompile section:

  after_assets_precompile:
      - exec:
          cd: $home
          cmd:
            - sudo -E -u discourse bundle exec rake s3:upload_assets
            - sudo -E -u discourse bundle exec rake s3:expire_missing_assets

... and run ./launcher rebuild app again. Then run "rake s3:upload_assets" and "rake s3:expire_missing_assets".

If both of the rakes complete without errors then re-add or uncomment the after_assets_precompile section, rebuild again and do the all the rakes listed above.
If either of the rakes give an error or the rebuild fails again you have something wrong in your app.yml, AWS S3 configs and/or DNS records. Happy hunting! :)

