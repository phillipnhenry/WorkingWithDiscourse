

You will need:
  IAM user with an appropriate policy see  s3-discourse-policy-your-iam-user.txt
  Two buckets - uploads (attached to DISCOURSE_S3_CDN_URL distribution) and backups (NOT attached to a CDN)
  Two Cloudfront S3 distributions - one for DISCOURSE_CDN_URL and one for DISCOURSE_S3_CDN_URL

There are many places to make mistakes. Using a naming convention strategy that makes sense to you and perhaps others will help you with troubleshooting especially if you are configuring multiple Discourse instances.

IAM user: your-iam-user
Policy: s3-discourse-policy-your-iam-user
Uploads bucket: your-bucket-name-uploads
Backups bucket: your-bucket-name-backups
Distribution CDNs: cdn-yourdomain-subdomain and  s3-yourdomain-subdomain-uploads

Discourse instance domain, IAM User, policy name, backups bucket name, uploads bucket name
  Discourse instance domain: subdomain.yourdomain (subdomain.yourdomain.tld including www.yourdomain.tld)
  IAM User: yourdomain-subdomain (yourdomain-discourse, yourdomain-forum or Discourse in apex root: yourdomain-tld-www )
  Policy for IAM user: s3-discourse-policy-yourdomain-subdomain
  Buckets
    yourdomain-subdomain-backups
    yourdomain-subdomain-uploads     Don't forget to set "Everyone (public access)" to "Read" in Bucket>Permissions: Access control list-(ACL) Access control list (ACL)-Grantee.


Distributions
cdn-yourdomain-subdomain            Origin: subdomain.yourdomain.tld             Cloudfront:   amazonassigned.cloudfront.net      CDN: discourse-cdn.yourdomain.tld
s3-yourdomain-subdomain-uploads     Origin: yourdomain-subdomain-uploads        Cloudfront:   amazonassigned.cloudfront.net       CDN: s3-cdn.yourdomain.tld



Use this for unbranded Cloudfront distributions. Your DISCOURSE_S3_REGION might be different.
# DISCOURSE_CDN_URL: https://amazonassigned.cloudfront.net

  ## S3 storage config
  DISCOURSE_USE_S3: true
  DISCOURSE_S3_REGION:  us-east-1
  DISCOURSE_S3_ACCESS_KEY_ID: key obfuscated
  DISCOURSE_S3_SECRET_ACCESS_KEY: key obfuscated
  DISCOURSE_S3_CDN_URL: https://amazonassigned.cloudfront.net
  DISCOURSE_S3_BUCKET: your-bucket-name-uploads
  DISCOURSE_S3_BACKUP_BUCKET: your-bucket-name-backups
  DISCOURSE_BACKUP_LOCATION: s3

If you prefer to use yourdomain.com based urls for the CDNs you need to make some DNS changes and adjust your CDN urls.
Don't forget to add discourse-cdn.yourdomain.com and s3-cdn.yourdomain.com as a domain name in "Alternate domain names" for their respective Cloudfront distributions.

DNS config if you want to use domain branded Cloudfront distributions.
DISCOURSE_CDN_URL
  Existing record:	A   discourseinstance.yourdomain.com   instance ip  Note: This is the existing Discourse install ip.
  New record:		A   discourse-cdn-cloudfront.yourdomain.com   instance ip
  New record: 		CNAME discourse-cdn.yourdomain.com  -->>   amazonassigned.cloudfront.net

DISCOURSE_S3_CDN_URL
  New record:		CNAME s3-cdn-cloudfront.yourdomain.com  -->>   amazonassigned.cloudfront.net
  New record: 		CNAME  s3-cdn.yourdomain.com  -->>   s3-cdn-cloudfront.yourdomain.com


Change DISCOURSE_CDN_URL and/or DISCOURSE_S3_CDN_URL if you are using domain CNAMES for the Cloudfront distribution (amazonassigned.cloudfront.net).

DISCOURSE_CDN_URL: https://discourse-cdn.yourdomain.com

## S3 storage config
  DISCOURSE_USE_S3: true
  DISCOURSE_S3_REGION:  us-east-1
  DISCOURSE_S3_ACCESS_KEY_ID: key obfuscated
  DISCOURSE_S3_SECRET_ACCESS_KEY: key obfuscated
  DISCOURSE_S3_CDN_URL: https://s3-cdn.yourdomain.com
  DISCOURSE_S3_BUCKET: s3-your-bucket-name-uploads
  DISCOURSE_S3_BACKUP_BUCKET: s3-your-bucket-name-backups
  DISCOURSE_BACKUP_LOCATION: s3


hooks:
  after_code:
    - exec:
        cd: $home/plugins
        cmd:
          - git clone https://github.com/discourse/docker_manager.git
          -you may have more plugins
after_assets_precompile:
    - exec:
        cd: $home
        cmd:
          - sudo -E -u discourse bundle exec rake s3:upload_assets
          - sudo -E -u discourse bundle exec rake s3:expire_missing_assets



After ./launcher rebuild app completes successfully do these rakes.

./launcher enter app

rake posts:rebake
rake uploads:migrate_to_s3
rake posts:rebake_uncooked_posts

rake s3:upload_assets
rake s3:expire_missing_assets

On some sites the initial rebuild will fail with an error relating to s3:upload_assets. If this happens comment out or remove

  after_assets_precompile:
      - exec:
          cd: $home
          cmd:
            - sudo -E -u discourse bundle exec rake s3:upload_assets
            - sudo -E -u discourse bundle exec rake s3:expire_missing_assets

and run ./launcher rebuild app again. Then run "rake s3:upload_assets" and "rake s3:expire_missing_assets".
If both of the rakes complete without errors then re-add or uncomment the after_assets_precompile section, rebuild again and do the all the rakes listed above.
If either of the rakes give an error or the rebuild fails again you have something wrong in your app.yml, AWS S3 configs and/or DNS records. Happy hunting! :)
