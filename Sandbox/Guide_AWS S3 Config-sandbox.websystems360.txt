Make these your own
  IAM user: your-iam-user
  Policy: s3-discourse-policy-your-iam-user
  Uploads bucket: your-bucket-name-uploads
  Backups bucket: your-bucket-name-backups
  Distribution CDNs: cdn-yourdomain-subdomain and  s3-yourdomain-subdomain-uploads

Discourse instance domain, IAM User, policy name, backups bucket name, uploads bucket name
  Discourse instance domain: sandbox.websystems360.com
  IAM User: websystems360-sandbox
  Policy for IAM user: s3-discourse-policy-websystems360-sandbox
  Buckets
    websystems360-sandbox-backups
    websystems360-sandbox-uploads     Don't forget to set "Everyone (public access)" to "Read" in Bucket>Permissions: Access control list-(ACL) Access control list (ACL)-Grantee.

Distributions
cdn-websystems360-sandbox            Origin: sandbox.websystems360.com           Cloudfront:   dqz0vziq4prj3.cloudfront.net      CDN: discourse-cdn.websystems360.com
s3-websystems360-sandbox-uploads     Origin: websystems360-sandbox-uploads        Cloudfront:   d3dq4zjnd9e3t0.cloudfront.net    CDN: s3-cdn.websystems360.com


DISCOURSE_CDN_URL: https://dqz0vziq4prj3.cloudfront.net

## S3 storage config
  DISCOURSE_USE_S3: true
  DISCOURSE_S3_REGION: us-east-1
  DISCOURSE_S3_ACCESS_KEY_ID:  key obfuscated
  DISCOURSE_S3_SECRET_ACCESS_KEY:  key obfuscated
  DISCOURSE_S3_CDN_URL: https://d3dq4zjnd9e3t0.cloudfront.net
  DISCOURSE_S3_BUCKET: websystems360-sandbox-uploads
  DISCOURSE_S3_BACKUP_BUCKET: websystems360-sandbox-backups
  DISCOURSE_BACKUP_LOCATION: s3

If you prefer to use yourdomain.com based urls for the CDNs you need to make some DNS changes and adjust your CDN urls.
Don't forget to add discourse-cdn.yourdomain.com and s3-cdn.yourdomain.com as a domain name in "Alternate domain names" for their respective Cloudfront distributions.

DISCOURSE_CDN_URL
already set  A   sandbox.websystems360.com   46.62.211.254  This is the Discourse app
  New record: A   discourse-cdn-cloudfront.websystems360.com   46.62.211.254
  New record: CNAME discourse-cdn.websystems360.com     dqz0vziq4prj3.cloudfront.net

DISCOURSE_S3_CDN_URL
  New record: CNAME s3-cdn-cloudfront.websystems360.com  d3dq4zjnd9e3t0.cloudfront.net
  New record: CNAME  s3-cdn.websystems360.com     s3-cdn-cloudfront.websystems360.com

Change DISCOURSE_CDN_URL and/or DISCOURSE_S3_CDN_URL if you are using domain CNAMES for the Cloudfront distribution (amazonassigned.cloudfront.net).

DISCOURSE_CDN_URL: https://discourse-cdn.websystems360.com      CNAME  -->>    dqz0vziq4prj3.cloudfront.net

## S3 storage config
  DISCOURSE_USE_S3: true
  DISCOURSE_S3_REGION: us-east-1
  DISCOURSE_S3_ACCESS_KEY_ID:  key obfuscated
  DISCOURSE_S3_SECRET_ACCESS_KEY:  key obfuscated
  DISCOURSE_S3_CDN_URL: https://s3-cdn.websystems360.com   CNAME  -->>    s3-cdn-cloudfront.websystems360.com
  DISCOURSE_S3_BUCKET: websystems360-sandbox-uploads
  DISCOURSE_S3_BACKUP_BUCKET: websystems360-sandbox-backups
  DISCOURSE_BACKUP_LOCATION: s3

hooks:
  after_code:
    - exec:
        cd: $home/plugins
        cmd:
          - git clone https://github.com/discourse/docker_manager.git
          -you may have more plugins
  after_assets_precompile:
    - exec:
        cd: $home
        cmd:
          - sudo -E -u discourse bundle exec rake s3:upload_assets
          - sudo -E -u discourse bundle exec rake s3:expire_missing_assets

After ./launcher rebuild app completes successfully do these rakes.

./launcher enter app

rake posts:rebake
rake uploads:migrate_to_s3
rake posts:rebake_uncooked_posts

rake s3:upload_assets
rake s3:expire_missing_assets


On some sites the initial rebuild will fail with an error relating to s3:upload_assets. If this happens comment out or remove

  after_assets_precompile:
      - exec:
          cd: $home
          cmd:
            - sudo -E -u discourse bundle exec rake s3:upload_assets
            - sudo -E -u discourse bundle exec rake s3:expire_missing_assets

and run ./launcher rebuild app again. Then run "rake s3:upload_assets" and "rake s3:expire_missing_assets".
If both of the rakes complete without errors then re-add or uncomment the after_assets_precompile section, rebuild again and do the all the rakes listed above.
If either of the rakes give an error or the rebuild fails again you have something wrong in your app.yml, AWS S3 configs and/or DNS records. Happy hunting! :)


